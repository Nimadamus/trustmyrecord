{% extends "base.html" %}

{% block title %}Profile - TrustMyRecord{% endblock %}

{% block content %}
<div class="container">
    <div class="glass-card profile-card">
        <h1>{{ user.username }}'s Profile</h1>
        <div class="profile-details">
            <img src="{{ url_for('static', filename='img/' + user.avatar_url) }}" alt="User Avatar" class="profile-avatar">
            <p><strong>Email:</strong> {% if user.email_private %}Private{% else %}{{ user.email }}{% endif %}</p>
            <p><strong>Joined:</strong> {{ user.date_joined.strftime('%Y-%m-%d') }}</p>
            <p><strong>Favorite Team:</strong> {{ user.favorite_team if user.favorite_team else 'N/A' }}</p>
            <p><strong>Total Posts:</strong> {{ user.posts|length }}</p>
            <p><strong>Career Record:</strong> [Coming Soon]</p>
        </div>

        <div class="profile-actions">
            <a href="{{ url_for('main.edit_profile') }}" class="cta-button small-btn">Edit Profile</a>
            <a href="{{ url_for('main.search_users') }}" class="cta-button small-btn">Search for Users</a>
            <a href="{{ url_for('main.user_messages') }}" class="cta-button small-btn">My Messages</a>
        </div>

        {% if user.id == current_user.id %}
        <div class="share-profile-section">
            <h2 class="section-heading">Share Your Profile</h2>
            <p class="centered-text">Show off your handicapping skills!</p>
            <a href="https://twitter.com/intent/tweet?text={{ user.username }}'s TrustMyRecord Profile: Check out my stats!&url={{ request.url }}" target="_blank" class="cta-button small-btn twitter-share-btn">
                Share on Twitter
            </a>
        </div>
        {% endif %}

        <h2 class="section-heading">Your Stats</h2>
        {% if user_stats %}
            <div class="stats-grid">
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.total_picks }}</div>
                    <div class="stat-label">Total Picks</div>
                </div>
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.wins }}</div>
                    <div class="stat-label">Wins</div>
                </div>
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.losses }}</div>
                    <div class="stat-label">Losses</div>
                </div>
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.pushes }}</div>
                    <div class="stat-label">Pushes</div>
                </div>
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.win_rate }}%</div>
                    <div class="stat-label">Win Rate</div>
                </div>
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.total_units }}</div>
                    <div class="stat-label">Total Units</div>
                </div>
                <div class="stat-box glass-card">
                    <div class="stat-number">{{ user_stats.roi }}%</div>
                    <div class="stat-label">ROI</div>
                </div>
            </div>
        {% else %}
            <p class="centered-text">No graded picks yet to calculate stats.</p>
        {% endif %}

        <h2 class="section-heading">Friend Requests</h2>
        {% if pending_requests %}
            <div class="friend-requests-list">
                {% for req in pending_requests %}
                    <div class="glass-card friend-request-card">
                        <span>{{ req.sender.username }} wants to be friends.</span>
                        <div class="friend-request-actions">
                            <form method="POST" action="{{ url_for('main.accept_friend_request', request_id=req.id) }}">
                                <button type="submit" class="cta-button small-btn accept-btn">Accept</button>
                            </form>
                            <form method="POST" action="{{ url_for('main.reject_friend_request', request_id=req.id) }}">
                                <button type="submit" class="cta-button small-btn reject-btn">Reject</button>
                            </form>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="centered-text">No pending friend requests.</p>
        {% endif %}

        <h2 class="section-heading">My Friends</h2>
        {% if friends %}
            <div class="friends-list">
                {% for friend in friends %}
                    <div class="glass-card friend-card">
                        <span>{{ friend.username }}</span>
                        <a href="{{ url_for('main.send_message', recipient_id=friend.id) }}" class="cta-button small-btn">Message</a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="centered-text">You don't have any friends yet.</p>
        {% endif %}

        {% if user.id == current_user.id and pending_picks.items %}
        <h2 class="section-heading">My Pending Picks</h2>
        <div class="picks-list">
            {% for pick in pending_picks.items %}
                <div class="glass-card pick-item pending-pick">
                    <p><strong>Sport:</strong> {{ pick.sport }}</p>
                    <p><strong>Event:</strong> {{ pick.event_details }}</p>
                    <p><strong>Pick:</strong> {{ pick.pick_selection }}</p>
                    <p><strong>Stake:</strong> {{ pick.stake_units }} units</p>
                    <p><strong>Odds:</strong> {{ pick.odds }}</p>
                    <p class="pick-timestamp">{{ pick.date_posted.strftime('%Y-%m-%d %H:%M') }}</p>
                </div>
            {% endfor %}
        </div>
        <div class="pagination">
            {% for page_num in pending_picks.iter_pages() %}
                {% if page_num %}
                    <a href="{{ url_for('main.profile', user_id=user.id, page=page_num) }}" class="btn btn-sm btn-outline-secondary">{{ page_num }}</a>
                {% else %}
                    ...
                {% endif %}
            {% endfor %}
        </div>
        {% elif user.id == current_user.id %}
            <p class="centered-text">You have no pending picks.</p>
        {% endif %}

        <h2 class="section-heading">{{ user.username }}'s Graded Picks</h2>
        {% if graded_picks.items %}
            <div class="picks-list">
                {% for pick in graded_picks.items %}
                    <div class="glass-card pick-item">
                        <p><strong>Sport:</strong> {{ pick.sport }}</p>
                        <p><strong>Event:</strong> {{ pick.event_details }}</p>
                        <p><strong>Pick:</strong> {{ pick.pick_selection }}</p>
                        <p><strong>Stake:</strong> {{ pick.stake_units }} units</p>
                        <p><strong>Odds:</strong> {{ pick.odds }}</p>
                        <p><strong>Result:</strong> {{ pick.result | title }}</p>
                        <p class="pick-timestamp">{{ pick.graded_timestamp.strftime('%Y-%m-%d %H:%M') }}</p>
                        <a href="https://twitter.com/intent/tweet?text=Check out my {{ pick.sport }} pick on TrustMyRecord! I picked {{ pick.pick_selection }} at {{ pick.odds }} odds. Result: {{ pick.result | title }}!&url={{ url_for('main.profile', user_id=user.id, _external=True) }}#pick-{{ pick.id }}" target="_blank" class="cta-button small-btn twitter-share-btn">
                            Share Pick
                        </a>
                    </div>
                {% endfor %}
            </div>
            <div class="pagination">
                {% for page_num in graded_picks.iter_pages() %}
                    {% if page_num %}
                        <a href="{{ url_for('main.profile', user_id=user.id, page=page_num) }}" class="btn btn-sm btn-outline-secondary">{{ page_num }}</a>
                    {% else %}
                        ...
                    {% endif %}
                {% endfor %}
            </div>
        {% else %}
            <p class="centered-text">{{ user.username }} hasn't made any graded picks yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}