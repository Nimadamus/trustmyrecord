{% extends "base.html" %}

{% block title %}Submit Pick - TrustMyRecord{% endblock %}

{% block content %}
<div class="container">
    <h1>Submit a New Pick</h1>
    <p class="centered-text">Select a sport, then choose your game and pick.</p>

    <div class="pick-selection-section glass-card">
        <p class="warning-message centered-text">⚠️ Warning: Once entered, your pick cannot be undone or changed.</p>

        <div class="form-group">
            <label for="sport-select">Select Sport:</label>
            <select id="sport-select" class="form-control">
                <option value="">-- Select a Sport --</option>
                <option value="nfl">NFL</option>
                <option value="nba">NBA</option>
                <option value="mlb">MLB</option>
                <option value="nhl">NHL</option>
                <option value="ncaaf">NCAAF</option>
                <option value="ncaab">NCAAB</option>
                <option value="soccer">Soccer</option>
                <option value="mma">MMA</option>
                <option value="golf">Golf</option>
            </select>
        </div>

        <div id="games-display" class="games-display">
            <!-- Games will be loaded here dynamically -->
            <p class="centered-text">Please select a sport to view games.</p>
        </div>

        <form id="submit-pick-form" method="POST" action="{{ url_for('main.submit_pick') }}" style="display: none;">
            {{ form.hidden_tag() }}
            <input type="hidden" name="sport" id="hidden-sport">
            <input type="hidden" name="event_details" id="hidden-event-details">
            <input type="hidden" name="pick_selection" id="hidden-pick-selection">
            <input type="hidden" name="stake_units" id="hidden-stake-units">
            <input type="hidden" name="odds" id="hidden-odds">
            <button type="submit" class="cta-button submit-pick-button">Confirm & Submit Pick</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const sportSelect = document.getElementById('sport-select');
        const gamesDisplay = document.getElementById('games-display');
        const submitPickForm = document.getElementById('submit-pick-form');
        const hiddenSport = document.getElementById('hidden-sport');
        const hiddenEventDetails = document.getElementById('hidden-event-details');
        const hiddenPickSelection = document.getElementById('hidden-pick-selection');
        const hiddenStakeUnits = document.getElementById('hidden-stake-units');
        const hiddenOdds = document.getElementById('hidden-odds');

        sportSelect.addEventListener('change', function() {
            const selectedSport = this.value;
            if (selectedSport) {
                fetch(`/picks/${selectedSport}`)
                    .then(response => response.text())
                    .then(html => {
                        // Extract only the content block from the fetched HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        const gamesContent = doc.querySelector('.games-display'); // Assuming sport_odds.html has a .games-display
                        if (gamesContent) {
                            gamesDisplay.innerHTML = gamesContent.innerHTML;
                            attachOddsButtonListeners();
                        } else {
                            gamesDisplay.innerHTML = '<p class="centered-text">Could not load games for this sport.</p>';
                        }
                        submitPickForm.style.display = 'none'; // Hide form until pick is selected
                    })
                    .catch(error => {
                        console.error('Error fetching games:', error);
                        gamesDisplay.innerHTML = '<p class="centered-text">Failed to load games. Please try again.</p>';
                    });
            } else {
                gamesDisplay.innerHTML = '<p class="centered-text">Please select a sport to view games.</p>';
                submitPickForm.style.display = 'none';
            }
        });

        function attachOddsButtonListeners() {
            document.querySelectorAll('.odds-button').forEach(button => {
                button.addEventListener('click', function() {
                    const confirmation = confirm('Are you sure you want to submit this pick? Once entered, it cannot be undone or changed.');
                    if (!confirmation) {
                        return; // Stop if user cancels
                    }

                    // Extract data from the button and its parent elements
                    const gameCard = this.closest('.game-card');
                    const sport = sportSelect.value;
                    const homeTeam = gameCard.querySelector('.game-header .team:first-child').textContent;
                    const awayTeam = gameCard.querySelector('.game-header .team:last-child').textContent;
                    const eventDetails = `${homeTeam} vs ${awayTeam}`;
                    const pickSelection = this.textContent.trim();
                    const odds = parseInt(this.dataset.odds || '-110'); // Use data-odds attribute
                    const stakeUnits = 1; // Default stake, can be made dynamic later

                    // Populate hidden form fields
                    hiddenSport.value = sport;
                    hiddenEventDetails.value = eventDetails;
                    hiddenPickSelection.value = pickSelection;
                    hiddenStakeUnits.value = stakeUnits;
                    hiddenOdds.value = odds;

                    // Submit the form directly
                    submitPickForm.submit();

                    // Optional: Highlight selected pick (this might be removed if direct submit is preferred)
                    document.querySelectorAll('.odds-button').forEach(btn => btn.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });
        }
    });
</script>
{% endblock %}